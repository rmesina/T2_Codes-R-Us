---
title: "CodesRUs Final Project Codefile"
authors: "Daniel Diaz, Ganesh Ghimire, Rose Mesina, and Michael Womble"
date: "March 9, 2022"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: cerulean
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(ggplot2)
library(ggsoccer)
library(ggpubr)
library(dplyr)
library(vtable)
library(purrr)
library(pROC)
library(regclass)
library(car)
library(corrplot)
library(pls)
library(mice)
library(ISLR)
library(leaps)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

# R-markdown: Modelling Soccer Match Events Code File

## Smart Questions:

We're looking to answer three SMART questions through the use of various models.

1. Given the variables that describe the (X, Y) coordinates of the beginning and end of key events (shots, assists, key passes), which configuration of the variables result in the best fitting model that gives the probability of a shot on goal being successful?

2. Based on match stats (i.e., percentage of possession of the ball, number of shots, number of shots on target, being home team vs being visitor team, etc.), can we predict who the winner of a particular match was?

3. Based on match stats (i.e., percentage of possession of the ball, number of shots, number of shots on target, being home team vs being visitor team, etc.), can we predict the number of goals scored by each team?

## Importing Data:

**Dataset:** The dataset contains all matches played in Europe’s top five leagues during the 2017/2018 season (380 matches per league for a total of 1900 matches, producing 643,149 match events), the 2016 European Championship (51 matches, producing 78,139 match events), and the 2018 World Cup (64 matches, 101,758 match events). It was obtained from the work posted by Luca Pappalardo on Figshare.

**Data Frame 1**
This data frame contains match events for all matches across all leagues and is used to answer SMART question 1. The data is imported by league and then compiled into a single event_data data frame, the event distance is calculated and added as a variable, giving a total of 3,251,294 events and 20 variables.
```{r loading data}
#Load Event data from each competition as a dataframe
england<-data.frame(read.csv('./datasets/event_England.csv'))
england$competition <- "England"

italy<-data.frame(read.csv('./datasets/event_Italy.csv'))
italy$competition <- "Italy"

germany<-data.frame(read.csv('./datasets/event_Germany.csv'))
germany$competition <- "Germany"

france<-data.frame(read.csv('./datasets/event_France.csv'))
france$competition <- "France"

spain<-data.frame(read.csv('./datasets/event_Spain.csv'))
spain$competition <- "Spain"

european<-data.frame(read.csv('./datasets/event_European_Championship.csv'))
european$competition <- "European"

worldcup<-data.frame(read.csv('./datasets/event_World_Cup.csv'))
worldcup$competition <- "World Cup"
                     
#Append dataframes into a single dataframe from which to draw.
event_data<-rbind(england, italy, germany, france, spain, european, worldcup)

#convert x and y coordinate columns from characters to integer values
event_data$x.End <- as.numeric(event_data$x.End)
event_data$y.End <- as.numeric(event_data$y.End)

event_data$x.Start <- as.numeric(event_data$x.Start)
event_data$y.Start <- as.numeric(event_data$y.Start)

#convert event, subevent, tags, players, team labels, etc... to factors
event_data$Event.Name=as.factor(event_data$Event.Name)
event_data$Subevent.Name=as.factor(event_data$Subevent.Name)
event_data$Match.Period=as.factor(event_data$Match.Period)
event_data$Match.Id=as.factor(event_data$Match.Id)
event_data$Player=as.factor(event_data$Player)
event_data$Team=as.factor(event_data$Team)
event_data$Tag.1=as.factor(event_data$Tag.1)
event_data$Tag.2=as.factor(event_data$Tag.2)
event_data$Tag.3=as.factor(event_data$Tag.3)
event_data$Tag.4=as.factor(event_data$Tag.4)
event_data$Tag.5=as.factor(event_data$Tag.5)
event_data$Tag.6=as.factor(event_data$Tag.6)
```

```{r calculate distance}

event_data<-event_data %>% mutate(dist = sqrt((x.End-x.Start)^2+(y.End-y.Start)^2))
event_data$dist <- as.numeric(event_data$dist)

xkabledplyhead(event_data)
```
**Table 1.** First five rows of event_data data frame.

```{r event datasets}
#Collect shots, goals, assists, and key passes into their own dataframes
shots<-subset(event_data, Event.Name=='Shot')
shots<-subset(shots, Tag.1!='Goal')
goals<-subset(event_data, Tag.1=='Goal')
goals<-subset(goals, Event.Name!='Save attempt')
assists<-subset(event_data, Tag.1=='Assist')
key_passes<-subset(event_data, Tag.1=='Key pass')
```

**Data Frame 2**
This data frame contains all match stats typically listed in the match summary of a game. These stats include shots, shots on target, passes, pass accuracy, possession (%), corners, offsides, fouls, yellows, and reds. This data frame was obtained using the match ID and counting each of these events for each match in data frame 1. This data frame is used to answer SMART question 2 & 3.
```{r match summary function}
match_ls<-event_data$Match.Id
match_ls<-unique(match_ls)

# Stat lists to put stats into
match_ids<-list()
team1s<-list()
team2s<-list()
winners<-list()
team1_goals<-list()
team2_goals<-list()
team1_shots<-list()
team1_shots_target<-list()
team2_shots<-list()
team2_shots_target<-list()
team1_passes<-list()
team1_pass_acc<-list()
team2_passes<-list()
team2_pass_acc<-list()
team1_possession<-list()
team2_possession<-list()
team1_fouls<-list()
team2_fouls<-list()
team1_yellows<-list()
team1_reds<-list()
team2_yellows<-list()
team2_reds<-list()
team1_offsides<-list()
team2_offsides<-list()
team1_corners<-list()
team2_corners<-list()
```

```{r for loop}
# for loop to get match stats for each match
for (match in match_ls) {
  match_data<-subset(event_data, Match.Id==match)

  match_time1<-subset(match_data, Match.Period=='1H')
  match_time2<-subset(match_data, Match.Period=='2H')
  
  time1<-match_time1$Event.Time
  time2<-match_time2$Event.Time
  
  time1<-prepend(time1, 0, before=1)
  time2<-prepend(time2, 0, before = 1)
  
  time1_duration<-diff(time1, lag = 1)
  time2_duration<-diff(time2, lag = 1)
  
  match_time1$Event.Duration<-time1_duration
  match_time2$Event.Duration<-time2_duration
  
  match_data<-rbind(match_time1, match_time2)
  
  #Get event data for each team in match
  teams<-match_data$Team
  teams<-unique(teams)
  team1=teams[1]
  team2=teams[2]
  team1_data<-subset(match_data, Team==team1)
  team2_data<-subset(match_data, Team==team2)
  
  team1s<-append(team1s, team1)
  team2s<-append(team2s, team2)
  
  match_ids<-append(match_ids, match)
  
  
  #Shots Data
  team1_shot<-subset(team1_data, Event.Name=='Shot')
  team1_shot_target<-subset(team1_shot, Tag.1=='Accurate' | Tag.2=='Accurate' | Tag.3=='Accurate' | Tag.4=='Accurate'| Tag.5=='Accurate' |   Tag.6=='Accurate')
    
  team2_shot<-subset(team2_data, Event.Name=='Shot')
  team_2shot_target<-subset(team2_shot, Tag.1=='Accurate' | Tag.2=='Accurate' | Tag.3=='Accurate' | Tag.4=='Accurate'| Tag.5=='Accurate' |   Tag.6=='Accurate')
    
  shots1<-length(team1_shot$Event.Name)
  shots2<-length(team2_shot$Event.Name)
  
  shot_target1<-length(team1_shot_target$Event.Name)
  shot_target2<-length(team_2shot_target$Event.Name)
  
  team1_shots<-append(team1_shots, shots1)
  team2_shots<-append(team2_shots, shots2)
  team1_shots_target<-append(team1_shots_target, shot_target1)
  team2_shots_target<-append(team2_shots_target, shot_target2)
  
  
  #Goals Data
  team1_goal<-subset(team1_data, Event.Name=='Shot' & Tag.1=='Goal')
  
  team2_goal<-subset(team2_shot, Event.Name=='Shot' & Tag.1=='Goal')
  
  goal1<-length(team1_goal$Event.Name)
  goal2<-length(team2_goal$Event.Name)
  
  team1_goals<-append(team1_goals, goal1)
  team2_goals<-append(team2_goals, goal2)
  
  # Determine winner
  if (goal1 > goal2) {
    winner<-'team1'}
  
  if (goal2 > goal1) {
    winner<-'team2'}
  
  winners<-append(winners, winner)
  #Pass Data
  
  #Subset pass data
  team1_pass<-subset(team1_data, Event.Name=='Pass')
  team1_pass_target<-subset(team1_pass, Tag.1=='Accurate' | Tag.2=='Accurate' | Tag.3=='Accurate' | Tag.4=='Accurate'| Tag.5=='Accurate' |   Tag.6=='Accurate')
    
  team2_pass<-subset(team2_data, Event.Name=='Pass')
  team2_pass_target<-subset(team2_pass, Tag.1=='Accurate' | Tag.2=='Accurate' | Tag.3=='Accurate' | Tag.4=='Accurate'| Tag.5=='Accurate' |   Tag.6=='Accurate')
    
  # Calculate Pass Stats
  passes_target1<-length(team1_pass_target$Event.Name)
  passes1<-length(team1_pass$Event.Name)
  passes_target2<-length(team2_pass_target$Event.Name)
  passes2<-length(team2_pass$Event.Name)
  pass_acc1<-passes_target1/passes1*100
  pass_acc2<-passes_target2/passes2*100
  
  # Add pass stat to lists
  team1_passes<-append(team1_passes, passes_target1)
  team2_passes<-append(team2_passes, passes_target2)
  team1_pass_acc<-append(team1_pass_acc, pass_acc1)
  team2_pass_acc<-append(team2_pass_acc, pass_acc2)
  
  # Corners
  corners1<-length(which(team1_data$Subevent.Name=='Corner'))
  corners2<-length(which(team2_data$Subevent.Name=='Corner'))
  
  team1_corners<-append(team1_corners, corners1)
  team2_corners<-append(team2_corners, corners2)
  
  #Possession Data
  team1_time<-sum(team1_data$Event.Duration)
  team2_time<-sum(team2_data$Event.Duration)
  match_time<-sum(match_data$Event.Duration)
  
  possession1<-team1_time/match_time*100
  possession2<-team2_time/match_time*100
  
  team1_possession<-append(team1_possession, possession1)
  team2_possession<-append(team2_possession, possession2)
  
  #Offside Data
  offside1<-length(which(team1_data$Event.Name=='Offside'))
  offside2<-length(which(team2_data$Event.Name=='Offside'))
  
  team1_offsides<-append(team1_offsides, offside1)
  team2_offsides<-append(team2_offsides, offside2)
  
  #Fouls Data (fouls committed by each team)
  fouls1<-length(which(team1_data$Event.Name=='Foul'))
  fouls2<-length(which(team2_data$Event.Name=='Foul'))
  
  team1_fouls<-append(team1_fouls, fouls1)
  team2_fouls<-append(team2_fouls, fouls2)
  
  #Card Data
  team1_yellow1<-subset(team1_data, Tag.1=='Yellow card' | Tag.2=='Yellow card' | Tag.3=='Yellow card' | Tag.4=='Yellow card'| Tag.5=='Yellow   card' | Tag.6=='Yellow card')
  
  team1_yellow2<-subset(team1_data, Tag.1=='Second yellow card' | Tag.2=='Second yellow card' | Tag.3=='Second yellow card' | Tag.4=='Second   yellow card'| Tag.5=='Second yellow card' | Tag.6=='Second yellow card')
  
  team1_yellow<-rbind(team1_yellow1, team1_yellow2)
    
  team1_red<-subset(team1_data, Tag.1=='Red card' | Tag.2=='Red card' | Tag.3=='Red card' | Tag.4=='Red card'| Tag.5=='Red card' | Tag.6=='Red   card')
    
  team2_yellow1<-subset(team2_data, Tag.1=='Yellow card' | Tag.2=='Yellow card' | Tag.3=='Yellow card' | Tag.4=='Yellow card'| Tag.5=='Yellow   card' | Tag.6=='Yellow card')
  
  team2_yellow2<-subset(team2_data, Tag.1=='Second yellow card' | Tag.2=='Second yellow card' | Tag.3=='Second yellow card' | Tag.4=='Second   yellow card'| Tag.5=='Second yellow card' | Tag.6=='Second yellow card')
  
  team2_yellow<-rbind(team2_yellow1, team2_yellow2)
    
  team2_red<-subset(team2_data, Tag.1=='Red card' | Tag.2=='Red card' | Tag.3=='Red card' | Tag.4=='Red card'| Tag.5=='Red card' | Tag.6=='Red   card')
  
  # Calculate card stats
  yellows1<-length(team1_yellow$Event.Name)
  yellows2<-length(team2_yellow$Event.Name)
  reds1<-length(team1_red$Event.Name)
  reds2<-length(team2_red$Event.Name)
  
  # Append to list
  team1_yellows<-append(team1_yellows, yellows1)
  team2_yellows<-append(team2_yellows, yellows2)
  team1_reds<-append(team1_reds, reds1)
  team2_reds<-append(team2_reds, reds2)
  }
```

```{r match summary dataframe}
lists<-list(match.id=match_ids,
            team1=team1s)
match_sum_df<-as.data.frame(do.call(cbind, lists))
match_sum_df$team2<-team2s
match_sum_df$winner<-winners
match_sum_df$team1.goals<-team1_goals
match_sum_df$team2.goals<-team2_goals
match_sum_df$team1.shots<-team1_shots
match_sum_df$team2.shots<-team2_shots
match_sum_df$team1.shots.target<-team1_shots_target
match_sum_df$team2.shots.target<-team2_shots_target
match_sum_df$team1.passes<-team1_passes
match_sum_df$team2.passes<-team2_passes
match_sum_df$team1.pass.acc<-team1_pass_acc
match_sum_df$team2.pass.acc<-team2_pass_acc
match_sum_df$team1.possession<-team1_possession
match_sum_df$team2.possession<-team2_possession
match_sum_df$team1.corners<-team1_corners
match_sum_df$team2.corners<-team2_corners
match_sum_df$team1.offsides<-team1_offsides
match_sum_df$team2.offsides<-team2_offsides
match_sum_df$team1.fouls<-team1_fouls
match_sum_df$team2.fouls<-team2_fouls
match_sum_df$team1.yellows<-team1_yellows
match_sum_df$team2.yellows<-team2_yellows
match_sum_df$team1.reds<-team1_reds
match_sum_df$team2.reds<-team2_reds

xkabledplyhead(match_sum_df)
```
**Table 2.** First five rows of match summary data frame. Each row is one match.

```{r write to csv}
library(data.table)
fwrite(match_sum_df,'C:\\Users\\dmmkm\\desktop\\match_summary.csv')
```

## Quick Review of EDA
Using the ggsoccer library to plot event data on an image of a pitch and bordering the x and y axis with event density plots we were quickly able to understand how each event is distributed on the pitch, shown in Figure 1.
```{r plot events on soccer pitch}
shots_fig<-ggplot(shots)+
  annotate_pitch()+
  geom_point(aes(x=x.Start, y=y.Start))+
  #scale_color_continuous(color='reds')+
  #geom_point(aes(x=x.Start, y=y.Start))+
  theme_pitch()+
  theme(plot.margin = unit(c(-0.5,-0.5,-0.5,-0.5), 'cm'))

goals_fig<-ggplot(goals)+
  annotate_pitch()+
  geom_point(aes(x=x.Start, y=y.Start))+
  theme_pitch()+
  theme(plot.margin = unit(c(-0.5,-0.5,-0.5,-0.5), 'cm'))

key_passes_fig<-ggplot(key_passes)+
  annotate_pitch()+
  geom_point(aes(x=x.Start, y=y.Start))+
  theme_pitch()+
  theme(plot.margin = unit(c(-0.5,-0.5,-0.5,-0.5), 'cm'))

assists_fig<-ggplot(assists)+
  annotate_pitch()+
  geom_point(aes(x=x.Start, y=y.Start))+
  theme_pitch()+
  theme(plot.margin = unit(c(-0.5,-0.5,-0.5,-0.5), 'cm'))
```

```{r density plots for pitch event plots}
key_passes_histx<-ggplot()+
  geom_density(data=(key_passes), aes(x=x.Start, y=..density..), color='Black', fill='Gold', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,-0.5,-0.1), 'cm'))

key_passes_histy<-ggplot()+
  geom_density(data=(key_passes), aes(x=y.Start, y=..density..), color='Black', fill='Gold', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,0.1,-0.5), 'cm'))+
  rotate()

assists_histx<-ggplot()+
  geom_density(data=(assists), aes(x=x.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,-0.5,-0.1), 'cm'))

assists_histy<-ggplot()+
  geom_density(data=(assists), aes(x=y.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,0.1,-0.5), 'cm'))+
  rotate()

shots_histx<-ggplot()+
  geom_density(data=(shots), aes(x=x.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,-0.5,-0.1), 'cm'))


shots_histy<-ggplot()+
  geom_density(data=(shots), aes(x=y.Start, y=..density..), color='Black', fill='Red', alpha=0.3, ylim=c(0,100))+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,0.1,-0.5), 'cm'))+
  rotate()

goals_histx<-ggplot()+
  geom_density(data=(goals), aes(x=x.Start, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,-0.5,-0.1), 'cm'))

goals_histy<-ggplot()+
  geom_density(data=(goals), aes(x=y.Start, y=..density..), color='Black', fill='Blue', alpha=0.3, ylim=c(0,100))+
  scale_x_continuous(limits = c(0,100))+
  theme(panel.background=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0,0,0.1,-0.5), 'cm'))+
  rotate()
```

```{r pitch+hist plots, fig.show='hold', out.width='50%'}
key_pass_dist_pitch<-ggarrange(key_passes_histx, NULL, key_passes_fig, key_passes_histy,
          ncol=2, nrow=2,
          widths=c(2,1), heights=c(1,2)) %>%
  annotate_figure(top=text_grob('Key Pass Distribution', face='bold', size=20))

assist_dist_pitch<-ggarrange(assists_histx, NULL, assists_fig, assists_histy,
          ncol=2, nrow=2,
          widths=c(2,1), heights=c(1,2)) %>%
  annotate_figure(top=text_grob('Assist Distribution', face='bold', size=20))

shot_dist_pitch<-ggarrange(shots_histx, NULL, shots_fig, shots_histy,
          ncol=2, nrow=2,
          widths=c(2,1), heights=c(1,2)) %>%
  annotate_figure(top=text_grob('Shot Distribution', face='bold', size=20))

goal_dist_pitch<-ggarrange(goals_histx, NULL, goals_fig, goals_histy,
          ncol=2, nrow=2,
          widths=c(2,1), heights=c(1,2)) %>%
  annotate_figure(top=text_grob('Goal Distribution', face='bold', size=20))

key_pass_dist_pitch
assist_dist_pitch
shot_dist_pitch
goal_dist_pitch
```
**Figure 1.** Event field locations and x & y-coordinate density plots for (Top Left) Key Passes, (Top Right) Assists, (Bottom Left) Shots, and (Bottom Right) Goals.

The distance distributions for key passes and assists are displayed in Figure 3. Both show fairly normal distributions, despite the fact that neither the x,y-coordinates for these two events show normal distributions. The distances of shots and goals were not examined as the x & y end coordinates given in the dataset were found to be inaccurate.
```{r event distance distribution, fig.show='hold', out.width='50%'}
key_pass_dist<-ggplot()+
  geom_density(data=key_passes, aes(x=dist, y=..density..), color='Black', fill='Gold', alpha=0.3)+
  xlim(c(0,150))+
  labs(title="Key Pass Distances", x="Distance", y="", )+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(size=16),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=16),
        plot.title = element_text(size=20, hjust = 0.5))

assist_dist<-ggplot()+
  geom_density(data=assists, aes(x=dist, y=..density..), color='Black', fill='Green', alpha=0.3)+
  xlim(c(0,150))+
  labs(title="Assist Distances", x="Distance", y="")+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(size=16),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=16),
        plot.title = element_text(size=20, hjust = 0.5))

shot_dist<-ggplot()+
  geom_density(data=shots, aes(x=dist, y=..density..), color='Black', fill='Red', alpha=0.3)+
  xlim(c(0,150))+
  labs(title="Shot Distances", x="Distance (yards)", y="")+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(size=16),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=16),
        plot.title = element_text(size=20, hjust = 0.5))

goal_dist<-ggplot()+
  geom_density(data=goals, aes(x=dist, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  xlim(c(0,150))+
  labs(title="Goal Distances", x="Distance (yards)", y="")+
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text.x = element_text(size=16),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=16),
        plot.title = element_text(size=20, hjust = 0.5))

key_pass_dist
assist_dist
```
**Figure 2.** Event distance for (Left)  Key Passes and (Right) Assists.

## SART Question 1: Modeling Goal Probability


## SMART Question 2: Predicting Match Winner
In order to predict the match winner based on the match summary variables, we decided to first reduce the number of variables taking the difference between a certain stat for the two teams. This halved the number of variables to look at. This resulted in the data frame in table 3, where a positive value is in favor of team 1 while a negative value favors team 2. Ratios were not used because many of the values in some of the variables have a zero value, so taking the ratio often resulted in not useful values.

```{r simplifying match summary}
match_summary <- data.frame(read.csv('./datasets/match_summary.csv'))

winner<-match_summary$winner
shot_ratio<-match_summary$team1.shots-match_summary$team2.shots
shot_ratio<-round(shot_ratio, digits=2)
shot_target_ratio<-match_summary$team1.shots.target-match_summary$team2.shots.target
shot_target_ratio<-round(shot_target_ratio, digits=2)
pass_ratio<-match_summary$team1.passes-match_summary$team2.passes
pass_ratio<-round(pass_ratio, digits=2)
pass_acc_ratio<-match_summary$team1.pass.acc-match_summary$team2.pass.acc
pass_acc_ratio<-round(pass_acc_ratio, digits=2)
possession_ratio<-match_summary$team1.possession-match_summary$team2.possession
possession_ratio<-round(possession_ratio, digits=2)
corners_ratio<-match_summary$team1.corners-match_summary$team2.corners
corners_ratio<-round(corners_ratio, digits=2)
offside_ratio<-match_summary$team1.offsides-match_summary$team2.offsides
offside_ratio<-round(offside_ratio, digits=2)
foul_ratio<-match_summary$team1.fouls-match_summary$team2.fouls
foul_ratio<-round(foul_ratio, digits=2)
yellow_ratio<-match_summary$team1.yellows-match_summary$team2.yellows
yellow_ratio<-round(yellow_ratio, digits=2)
red_ratio<-match_summary$team1.reds-match_summary $team2.reds
red_ratio<-round(red_ratio, digits=2)
lists<-list(winner=winner,
            shot.dif=shot_ratio,
            shot.target.dif=shot_target_ratio,
            pass.dif=pass_ratio,
            pass.acc.dif=pass_acc_ratio,
            possession.dif=possession_ratio,
            corners.dif=corners_ratio,
            offside.dif=offside_ratio,
            foul.dif=foul_ratio,
            yellow.dif=yellow_ratio,
            red.dif=red_ratio)
match_diff<-as.data.frame(do.call(cbind, (lists)))
match_diff$winner<-as.factor(match_diff$winner)
match_diff$shot.dif<-as.numeric(match_diff$shot.dif)
match_diff$shot.target.dif<-as.numeric(match_diff$shot.target.dif)
match_diff$pass.dif<-as.numeric(match_diff$pass.dif)
match_diff$pass.acc.dif<-as.numeric(match_diff$pass.acc.dif)
match_diff$possession.dif<-as.numeric(match_diff$possession.dif)
match_diff$corners.dif<-as.numeric(match_diff$corners.dif)
match_diff$offside.dif<-as.numeric(match_diff$offside.dif)
match_diff$foul.dif<-as.numeric(match_diff$foul.dif)
match_diff$yellow.dif<-as.numeric(match_diff$yellow.dif)
match_diff$red.dif<-as.numeric(match_diff$red.dif)
xkabledplyhead(match_diff)
```
**Table 3.** First five rows of match_difference data frame. 

In the first model all variables in the match_difference data frame were used. Looking at the summary of the model, only 5 out of the 11 variables were found to have any significance (shot.dif, shot.target.dif, pass.acc.dif, corners.dif, and red.dif).
```{r logistical regression model 1}
library(bestglm)
winner_model<-glm(winner ~ ., data=match_diff, family='binomial')
summary(winner_model)
```

In model 2 only the variables found to be significant were included.
```{r logistical regression model 2}
winner_model2<-glm(winner ~ shot.dif + shot.target.dif + pass.acc.dif + corners.dif, data = match_diff, family='binomial')
summary(winner_model2)
```
Comparing model 1 and model 2 AIC values, they are found to be the same. Therefore, we decided to train and test model 2 as it has fewer variables but performs just as well as model 1.

To train model 2, we created train and test data sets in 20-80 split of the match-diff data frame.
```{r train and test}
# Make training and test data sets
set.seed(1)
row.number<-sample(1:nrow(match_diff), 0.8*nrow(match_diff))
match_train<-match_diff[row.number,]
match_test<-match_diff[-row.number,]

## Train
winner_model2<-glm(winner ~ shot.dif + shot.target.dif + pass.acc.dif + corners.dif + red.dif, data=match_train, family='binomial')

## Test
pred<-predict(winner_model2, newdata = match_test, type='response')
match_test$pred=pred
```

Next, we analyzed the test results of model 2 by first making a confusion matrix, from which we could calculate the accuracy, which is 73%.
```{r model 2 confusion matrix}
## Confusion Matrix
conf_matrix<-xkabledply(confusion_matrix(winner_model2), title = "Confusion matrix from Logit Model" )
conf_matrix
accuracy=(567+562)/1552
recall=(214+562)/776
```
**Table 4.** Confusion matrix of test results for winner_model2.

We finished by looking at the ROC plot of our test results and found the area under the curve (AUC) was found to be 0.804.
```{r ROC plot and AUC}
## Calculate ROC and AUC
h <- roc(winner~pred, data=match_test)
#auc(h)
plot(h)
```
**Figure 3.** ROC plot showing test results of winner_model2.

## SMART Question 3: Predicting Number of Goals Scored
In order to analyze the goals variable, we need to transform the data set from long to wide. This way, each match-team combination will have a corresponding # goals value stored in the same column.

```{r long to wide}
#Create separate datasets for Team1 and Team2. Only keeping totals as well as the relevant team's stats

team1 <- match_summary[c('team1','team1.goals', 'team1.shots','team1.shots.target','team1.passes','team1.pass.acc','team1.possession','team1.corners','team1.offsides','team1.fouls','team1.yellows','team1.reds')]

colnames(team1) <- c('team', 'goals', 'shots', 'shots.target', 'passes','pass.acc', 'possession', 'corners', 'offsides', 'fouls', 'yellows', 'reds')

team2 <- match_summary[c('team2','team2.goals', 'team2.shots','team2.shots.target','team2.passes','team2.pass.acc','team2.possession','team2.corners','team2.offsides','team2.fouls','team2.yellows','team2.reds')]

colnames(team2) <- c('team', 'goals', 'shots', 'shots.target', 'passes','pass.acc', 'possession', 'corners', 'offsides', 'fouls', 'yellows', 'reds')

teams <- rbind(team1, team2)
teams_cont <- subset(teams, select = -c(team))
```

The data set, teams, now has 3,882 records that can be used to analyze number of goals and the factors that influence it. To get an idea of correlations between the variables we can look at a correlation plot.

```{r correlation}
#install.packages("corrplot")
corr <- cor(teams_cont)
corrplot.mixed(corr)
```
**Figure**

We will run various linear regression models and evaluate them against one another. For this exercise, we will only use continuous variables and then check adjusted R squared to compare models.

```{r linear regressions}
best2 <- regsubsets(goals~., data = teams_cont, nbest = 2, method='seqrep')
plot(best2, scale = "adjr2", main = "Adjusted R^2")
plot(best2, scale = "bic", main = "BIC")

# The best model
adjr2_bic_model <- lm(goals ~ shots + shots.target + pass.acc + possession + corners + fouls, data = teams_cont)

summary(adjr2_bic_model)

vif(adjr2_bic_model)
```

The best model for goals, under both adjusted R squared and BIC methods, consists of shots, shots.target, pass.acc, possession, corners, and fouls. This model, however, only has an adjusted R Squared value of 0.408. This indicates that there is some information being left out of the model that could explain variation in number of goals.


```{r Making training and testing datasets}
# Make training and test data sets
set.seed(1)
row.number<-sample(1:nrow(teams), 0.8*nrow(teams))
teams_train<-teams[row.number,]
teams_test<-teams[-row.number,]

# Train model
model_goals<-lm(goals ~ shots + shots.target + pass.acc + possession + corners + fouls, data=teams_train)
summary(model_goals)
plot(model_goals)
```
**Figure**

```{r test linear regression model}
# Test model
teams_test$pred_goals<-predict(model_goals, newdata=teams_test)
rmse <- sqrt(sum((exp(teams_test$pred_goals) - teams_test$goals)^2)/length(teams_test$goals))
c(RMSE = rmse, R2=summary(model_goals)$r.squared)

plot(teams_test$goals, teams_test$pred_goals, xlab='Expected Goals', ylab='Predicted Goals', main='Results of Testing', ylim = c(-0.5,7), xlim=c(-0.5,7))
abline(lm(pred_goals~goals,data=teams_test),col='red')
```
**Figure**

Now we want to see whether we can incorporate these variables without worrying about multicollinearity, as well as find any trends or relations previously hidden from us. We may be able to do that using PCA/PCR.

```{r PCA}
teams_cont_scaled <- data.frame(scale(teams_cont))

teams_pca <- prcomp(teams_cont_scaled)
xkabledply(teams_pca)
```

```{r PCR}
pcr.fit.cont=pcr(goals~.,data=teams_cont,scale=TRUE,validation ="CV")

summary(pcr.fit.cont)

validationplot(pcr.fit.cont, val.type = "R2")
```

```{r test}
teamsscaled.pc <- PCAxform( teams_cont[,2:11], z=TRUE ) # exclude goals column at index 1
teamsscaled.pc$goals = teams_cont[,1] # copy back the goals as y-target
head(teamsscaled.pc)

fit_pc <- lm(goals~., data = teamsscaled.pc)
ezids::xkabledply(fit_pc, title = "Full model using Principal Comps")
summary(fit_pc)

fit_pc_lim <- lm(goals~PC1+PC2+PC7+PC9, data = teamsscaled.pc)
ezids::xkabledply(fit_pc_lim, title = "Limited model using Principal Comps")
summary(fit_pc_lim)
```