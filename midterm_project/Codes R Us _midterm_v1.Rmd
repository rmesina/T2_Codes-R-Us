---
title: "CodesRUs_midterm"
output: html_document
---

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(ggplot2)
library(ggsoccer)
library(dplyr)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

## R Markdown

1. Import datasets

```{r load data}
#Load Event data from each competition as a dataframe
england<-data.frame(read.csv('./datasets/events_England_new.csv'))
italy<-data.frame(read.csv('./datasets/events_Italy_new.csv'))
germany<-data.frame(read.csv('./datasets/events_Germany_new.csv'))
france<-data.frame(read.csv('./datasets/events_France_new.csv'))
spain<-data.frame(read.csv('./datasets/events_Spain_new.csv'))
european<-data.frame(read.csv('./datasets/events_European_Championship_new.csv'))
worldcup<-data.frame(read.csv('./datasets/events_World_Cup_new.csv'))
                     
```

```{r combine data frames}
#Append dataframes into a single dataframe from which to draw.
event_data<-rbind(england, italy, germany, france, spain, european, worldcup)
str(event_data)
head(event_data)
tail(event_data)
```

There are a total of 3,251,294 events and 18 variables. We continue by converting data types where needed.

```{r convert variables}
#convert x and y coordinate columns from characters to integer values
event_data$x.End <- as.numeric(event_data$x.End)
event_data$y.End <- as.numeric(event_data$y.End)

event_data$x.Start <- as.numeric(event_data$x.Start)
event_data$y.Start <- as.numeric(event_data$y.Start)

#convert event and subevent labels to factors
event_data$Event.Name=as.factor(event_data$Event.Name)
event_data$Subevent.Name=as.factor(event_data$Subevent.Name)

str(event_data)
```

X and Y coordinates have been successfully converted to numeric. Event Name and Subevent Name are have also been converted to factor. We continue by calculating distance for relevant variables of interest.


```{r calculate distance}

event_data<-event_data %>% mutate(dist = sqrt((x.End-x.Start)^2+(y.End-y.Start)^2))

event_data$dist <- as.numeric(event_data$dist)

summary(event_data$dist)
str(event_data)
```

Distance has been calculated. Continue by creating separate dataframes for each event of interest.

```{r event datasets}
#Collect shots, goals, assists, and key passes into their own dataframes
shots<-subset(event_data, Event.Name=='Shot')
goals<-subset(event_data, Tag.1=='Goal')
assists<-subset(event_data, Tag.1=='Assist')
key_passes<-subset(event_data, Tag.1=='Key pass')

head(shots)
head(goals)
head(assists)
head(key_passes)

```

For each event of interest, check for and remove outliers.

```{r checking for outliers}
assists_clean<-outlierKD2(assists, dist, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean<-na.omit(assists_clean)

assists_clean_x<-outlierKD2(assists, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean_x<-na.omit(assists_clean_x)

assists_clean_y<-outlierKD2(assists, y.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean_y<-na.omit(assists_clean_y)

key_passes_clean<-outlierKD2(key_passes, dist, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean<-na.omit(key_passes_clean)

key_passes_clean_x<-outlierKD2(key_passes, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean_x<-na.omit(key_passes_clean_x)

key_passes_clean_y<-outlierKD2(key_passes, y.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean_y<-na.omit(key_passes_clean_y)

shots_clean<-outlierKD2(shots, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
shots_clean<-na.omit(shots_clean)

goals_clean<-outlierKD2(goals, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
goals_clean<-na.omit(goals_clean)

```

Quick visual of the field: Plot start position and distance of each event.

```{r quick visuals}

#Shots
jpeg(file="shots_start.jpeg")
plot(shots_clean$x.Start,shots_clean$y.Start,main='Start Position of Shots', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="shots_dist.jpeg")
hist(shots_clean$dist, main='Distance of Shots', xlab = 'Shot Distance')
dev.off()

#Goals
jpeg(file="goals_start.jpeg")
plot(goals_clean$x.Start,goals_clean$y.Start,main='Start Position of Goals', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="goals_dist.jpeg")
hist(goals_clean$dist, main='Distance of Shots Leading to Goals', xlab = 'Shot Distance')
dev.off()

#Assists

jpeg(file="assists_start.jpeg")
plot(assists_clean$x.Start,assists_clean$y.Start,main='Start Position of Assists', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="assists_dist.jpeg")
hist(assists_clean$dist, main='Distance of Assists', xlab = 'Shot Distance')
dev.off()

#Key Passes

jpeg(file="keypass_start.jpeg")
plot(key_passes_clean$x.Start,key_passes_clean$y.Start,main='Start Position of Key Passes', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="keypass_dist.jpeg")
hist(key_passes_clean$dist, main='Distance of Key Passes', xlab = 'Shot Distance')
dev.off()
```

Visualize distributions of variables of interest.

```{r viz dist}

#Histograms of Assist and Key Pass Distance

ggplot()+
  geom_histogram(data=assists_clean, aes(x=dist, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=key_passes_clean, aes(x=dist, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$dist), sd = sd(assists_clean$dist)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$dist), sd = sd(key_passes_clean$dist)), color='dark red', fill='green', size=1)+
  
  labs(title="Distance of Assists and Key Passes with Normal Distribution Fit", x="Distance", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_dist.jpeg")
```

```{r}

#Histograms of Assist and Key Pass x Coordinates

ggplot()+
  geom_histogram(data=(assists_clean), aes(x=x.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=(key_passes_clean), aes(x=x.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$x.Start), sd = sd(assists_clean$x.Start)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$x.Start), sd = sd(key_passes_clean$x.Start)), color='dark red', fill='red', size=1)+
  
  labs(title="X-coordinates of Key Passes & Assists with Normal Distribution Fits", x="x-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_x.jpeg")

```

```{r}

#Histograms of Assist and Key Pass y Coordinates

ggplot()+
  geom_histogram(data=(assists_clean), aes(x=y.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=(key_passes_clean), aes(x=y.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$y.Start), sd = sd(assists_clean$y.Start)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$y.Start), sd = sd(key_passes_clean$y.Start)), color='dark red', fill='red', size=1)+
  
  labs(title="Y-coordinates of Key Passes & Assists with Normal Distribution Fits", x="y-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_y.jpeg")
```

```{r}

#Histograms of shots and goals x coordinates

ggplot()+
  geom_histogram(data=(shots_clean), aes(x=x.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  geom_histogram(data=(goals_clean), aes(x=x.Start, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(shots_clean$x.Start), sd = sd(shots_clean$x.Start)), color='dark red', fill='red', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(goals_clean$x.Start), sd = sd(goals_clean$x.Start)), color='dark blue', fill='blue', size=1)+
  
  labs(title="X-coordinates of Shots & Goals with Normal Distribution Fits", x="x-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Blue', 'Red'), labels=c('Goals','Shots'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("shots_goals_x.jpeg")

```

```{r}

#Histograms of shots and goals y coordinates

ggplot()+
  geom_histogram(data=shots_clean, aes(x=y.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  geom_histogram(data=goals_clean, aes(x=y.Start, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(shots_clean$y.Start), sd = sd(shots_clean$y.Start)), color='dark red', fill='red', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(goals_clean$y.Start), sd = sd(goals_clean$y.Start)), color='dark blue', fill='blue', size=1)+
  
  labs(title="Y-coordinates of Shots & Goals with Normal Distribution Fits", x="y-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Blue', 'Red'), labels=c('Goals','Shots'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("shots_goals_y.jpeg")
```

Upon reviewing the plots, it appears that there are some differences between some variables. We will continue by performing some hypothesis tests.

```{r hypothesis testing}

#Distance

ttest_assist_v_keypass_dist <- t.test(assists_clean$dist, key_passes_clean$dist)

ttest_assist_v_keypass_dist

capture.output(ttest_assist_v_keypass_dist, file = "ttest_assist_v_keypass_dist.txt")

ttest_goals_v_shots_dist <- t.test(goals_clean$dist, shots_clean$dist)

ttest_goals_v_shots_dist

#Starting X-coordinate

ttest_assist_v_keypass_x <- t.test(assists_clean_x$x.Start, key_passes_clean_x$x.Start)

ttest_assist_v_keypass_x

ttest_goals_v_shots_x <- t.test(goals_clean$x.Start, shots_clean$x.Start)

ttest_goals_v_shots_x

#Starting Y-coordinate

ttest_assist_v_keypass_y <- t.test(assists_clean_y$y.Start, key_passes_clean_y$y.Start)

ttest_assist_v_keypass_y

ttest_goals_v_shots_y <- t.test(goals_clean$y.Start, shots_clean$y.Start)

ttest_goals_v_shots_y

```

ttest95_assists<-t.test(assists_clean$assist_dist, mu=mean(key_passes_clean$keypass_dist), conf.level=0.95)
ttest95_assists
ttest95_goals_x<-t.test(goals_clean$x.Start, mu=mean(shots_clean$x.Start), conf.level = 0.95)
ttest95_goals_x
ttest95_goals_y<-t.test(goals_clean$y.Start, mu=mean(shots_clean$y.Start), conf.level = 0.95)
ttest95_goals_y
```
```{r Dividing histograms to get ratios}
hist_goals<-hist(goals_clean$x.Start)
hist_shots<-hist(shots_clean$x.Start)
hist_goals_counts<-hist_goals$counts
hist_shots_counts<-hist_shots$counts
hist_goalshot_ratio<-hist_goals_counts/hist_shots_counts

ggplot+
  geom_histogram()
```

```{r}
xkabledply(head(event_data))
head(event_data)
```