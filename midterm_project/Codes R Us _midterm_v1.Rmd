---
title: "CodesRUs_midterm"
output: html_document
---

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(ggplot2)
library(ggsoccer)
library(dplyr)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

## R Markdown

1. Import datasets

```{r load data}
#Load Event data from each competition as a dataframe
england<-data.frame(read.csv('./datasets/events_England_new.csv'))
england$competition <- "England"

italy<-data.frame(read.csv('./datasets/events_Italy_new.csv'))
italy$competition <- "Italy"

germany<-data.frame(read.csv('./datasets/events_Germany_new.csv'))
germany$competition <- "Germany"

france<-data.frame(read.csv('./datasets/events_France_new.csv'))
france$competition <- "France"

spain<-data.frame(read.csv('./datasets/events_Spain_new.csv'))
spain$competition <- "Spain"

european<-data.frame(read.csv('./datasets/events_European_Championship_new.csv'))
european$competition <- "European"

worldcup<-data.frame(read.csv('./datasets/events_World_Cup_new.csv'))
worldcup$competition <- "World Cup"
                     
```

```{r combine data frames}
#Append dataframes into a single dataframe from which to draw.
event_data<-rbind(england, italy, germany, france, spain, european, worldcup)
str(event_data)
head(event_data)
tail(event_data)
```

There are a total of 3,251,294 events and 19 variables. We continue by converting data types where needed.

```{r convert variables}
#convert x and y coordinate columns from characters to integer values
event_data$x.End <- as.numeric(event_data$x.End)
event_data$y.End <- as.numeric(event_data$y.End)

event_data$x.Start <- as.numeric(event_data$x.Start)
event_data$y.Start <- as.numeric(event_data$y.Start)

#convert event and subevent labels to factors
event_data$Event.Name=as.factor(event_data$Event.Name)
event_data$Subevent.Name=as.factor(event_data$Subevent.Name)

str(event_data)
```

X and Y coordinates have been successfully converted to numeric. Event Name and Subevent Name are have also been converted to factor. We continue by calculating distance for relevant variables of interest.


```{r calculate distance}

event_data<-event_data %>% mutate(dist = sqrt((x.End-x.Start)^2+(y.End-y.Start)^2))

event_data$dist <- as.numeric(event_data$dist)

summary(event_data$dist)
str(event_data)
```

Distance has been calculated. Continue by creating separate dataframes for each event of interest.

```{r event datasets}
#Collect shots, goals, assists, and key passes into their own dataframes
shots<-subset(event_data, Event.Name=='Shot')
goals<-subset(event_data, Tag.1=='Goal')
assists<-subset(event_data, Tag.1=='Assist')
key_passes<-subset(event_data, Tag.1=='Key pass')

head(shots)
head(goals)
head(assists)
head(key_passes)

```

For each event of interest, check for and remove outliers.

```{r checking for outliers}
assists_clean<-outlierKD2(assists, dist, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean<-na.omit(assists_clean)

assists_clean_x<-outlierKD2(assists, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean_x<-na.omit(assists_clean_x)

assists_clean_y<-outlierKD2(assists, y.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
assists_clean_y<-na.omit(assists_clean_y)

key_passes_clean<-outlierKD2(key_passes, dist, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean<-na.omit(key_passes_clean)

key_passes_clean_x<-outlierKD2(key_passes, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean_x<-na.omit(key_passes_clean_x)

key_passes_clean_y<-outlierKD2(key_passes, y.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
key_passes_clean_y<-na.omit(key_passes_clean_y)

shots_clean<-outlierKD2(shots, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
shots_clean<-na.omit(shots_clean)

goals_clean<-outlierKD2(goals, x.Start, rm=TRUE, boxplt = TRUE, histogram = TRUE, qqplt = TRUE)
goals_clean<-na.omit(goals_clean)

```

Quick visual of the field: Plot start position and distance of each event.

```{r quick visuals}

#Shots
jpeg(file="shots_start.jpeg")
plot(shots_clean$x.Start,shots_clean$y.Start,main='Start Position of Shots', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="shots_dist.jpeg")
hist(shots_clean$dist, main='Distance of Shots', xlab = 'Shot Distance')
dev.off()

#Goals
jpeg(file="goals_start.jpeg")
plot(goals_clean$x.Start,goals_clean$y.Start,main='Start Position of Goals', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="goals_dist.jpeg")
hist(goals_clean$dist, main='Distance of Shots Leading to Goals', xlab = 'Shot Distance')
dev.off()

#Assists

jpeg(file="assists_start.jpeg")
plot(assists_clean$x.Start,assists_clean$y.Start,main='Start Position of Assists', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="assists_dist.jpeg")
hist(assists_clean$dist, main='Distance of Assists', xlab = 'Shot Distance')
dev.off()

#Key Passes

jpeg(file="keypass_start.jpeg")
plot(key_passes_clean$x.Start,key_passes_clean$y.Start,main='Start Position of Key Passes', xlab = 'x.Start', ylab = 'y.Start')
dev.off()

jpeg(file="keypass_dist.jpeg")
hist(key_passes_clean$dist, main='Distance of Key Passes', xlab = 'Shot Distance')
dev.off()
```

Visualize distributions of variables of interest.

```{r viz dist}

#Histograms of Assist and Key Pass Distance

ggplot()+
  geom_histogram(data=assists_clean, aes(x=dist, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=key_passes_clean, aes(x=dist, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$dist), sd = sd(assists_clean$dist)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$dist), sd = sd(key_passes_clean$dist)), color='dark red', fill='green', size=1)+
  
  labs(title="Distance of Assists and Key Passes with Normal Distribution Fit", x="Distance", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_dist.jpeg")
```

```{r}

#Histograms of Assist and Key Pass x Coordinates

ggplot()+
  geom_histogram(data=(assists_clean), aes(x=x.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=(key_passes_clean), aes(x=x.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$x.Start), sd = sd(assists_clean$x.Start)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$x.Start), sd = sd(key_passes_clean$x.Start)), color='dark red', fill='red', size=1)+
  
  labs(title="X-coordinates of Key Passes & Assists with Normal Distribution Fits", x="x-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_x.jpeg")

```

```{r}

#Histograms of Assist and Key Pass y Coordinates

ggplot()+
  geom_histogram(data=(assists_clean), aes(x=y.Start, y=..density..), color='Black', fill='Green', alpha=0.3)+
  
  geom_histogram(data=(key_passes_clean), aes(x=y.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(assists_clean$y.Start), sd = sd(assists_clean$y.Start)), color='dark green', fill='green', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(key_passes_clean$y.Start), sd = sd(key_passes_clean$y.Start)), color='dark red', fill='red', size=1)+
  
  labs(title="Y-coordinates of Key Passes & Assists with Normal Distribution Fits", x="y-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Green', 'Red'), labels=c('Assists','Key Passes'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("assist_keypass_y.jpeg")
```

```{r}

#Histograms of shots and goals x coordinates

ggplot()+
  geom_histogram(data=(shots_clean), aes(x=x.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  geom_histogram(data=(goals_clean), aes(x=x.Start, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(shots_clean$x.Start), sd = sd(shots_clean$x.Start)), color='dark red', fill='red', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(goals_clean$x.Start), sd = sd(goals_clean$x.Start)), color='dark blue', fill='blue', size=1)+
  
  labs(title="X-coordinates of Shots & Goals with Normal Distribution Fits", x="x-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Blue', 'Red'), labels=c('Goals','Shots'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("shots_goals_x.jpeg")

```

```{r}

#Histograms of shots and goals y coordinates

ggplot()+
  geom_histogram(data=shots_clean, aes(x=y.Start, y=..density..), color='Black', fill='Red', alpha=0.3)+
  
  geom_histogram(data=goals_clean, aes(x=y.Start, y=..density..), color='Black', fill='Blue', alpha=0.3)+
  
  stat_function(fun = dnorm, args = list(mean = mean(shots_clean$y.Start), sd = sd(shots_clean$y.Start)), color='dark red', fill='red', size=1)+
  
  stat_function(fun = dnorm, args = list(mean = mean(goals_clean$y.Start), sd = sd(goals_clean$y.Start)), color='dark blue', fill='blue', size=1)+
  
  labs(title="Y-coordinates of Shots & Goals with Normal Distribution Fits", x="y-coordinate", y="Normalized Count")+
  
  scale_color_manual(name='Key',values=c('Blue', 'Red'), labels=c('Goals','Shots'))+
  theme(panel.background = element_blank(),
        panel.border=element_rect(color='black', fill=NA),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))

ggsave("shots_goals_y.jpeg")
```

Upon reviewing the plots, it appears that there are some differences between some variables. We will continue by performing some hypothesis tests.

```{r hypothesis testing}

#Distance

ttest_assist_v_keypass_dist <- t.test(assists_clean$dist, key_passes_clean$dist)

capture.output(ttest_assist_v_keypass_dist, file = "ttests.txt", append = T)

ttest_goals_v_shots_dist <- t.test(goals_clean$dist, shots_clean$dist)

capture.output(ttest_goals_v_shots_dist, file = "ttests.txt", append = T)

#Starting X-coordinate

ttest_assist_v_keypass_x <- t.test(assists_clean_x$x.Start, key_passes_clean_x$x.Start)

capture.output(ttest_assist_v_keypass_x, file = "ttests.txt", append = T)

ttest_goals_v_shots_x <- t.test(goals_clean$x.Start, shots_clean$x.Start)

capture.output(ttest_goals_v_shots_x, file = "ttests.txt", append = T)

#Starting Y-coordinate

ttest_assist_v_keypass_y <- t.test(assists_clean_y$y.Start, key_passes_clean_y$y.Start)

capture.output(ttest_assist_v_keypass_y, file = "ttests.txt", append = T)

ttest_goals_v_shots_y <- t.test(goals_clean$y.Start, shots_clean$y.Start)

capture.output(ttest_goals_v_shots_y, file = "ttests.txt", append = T)

```

Based on the t-tests, the following variables have significantly different means at the 95% level.

1. Assist v. Key Pass Distance (higher mean for key pass)
2. Goal v. Shot Distance (higher mean for goals)
3. Goal v. Shot x.Start (higher mean for goals)
4. Goal v. Shot y.Start (higher mean for goals)

Based on this finding, it must be the case that teams consider strategies such as planning their starting points or practicing the accuracy of their shots in order to cover a desirable distance.

Regardless of the result (goal v shot, assist v key pass), how do each team's distance and starting points compare to other teams? Let's take a look at the World Cup in particular.

```{r}
# Stack assist and key pass dataset

assist_key_pass <-rbind(assists_clean, key_passes_clean)
assist_key_pass_wc <- subset(assist_key_pass, competition=="World Cup")

str(assist_key_pass_wc)
head(assist_key_pass_wc)

# Focus on top 5 teams with most assists + key passes
freq1 <- sort(table(assist_key_pass_wc$Team.Name),decreasing=T)
print(freq1)

assist_key_pass_wc_top5 <- subset(assist_key_pass_wc, Team.Name == "Belgium" | Team.Name == "England" | Team.Name == "Croatia" | Team.Name == "Brazil" | Team.Name == "France")

jpeg(file="assist_key_pass_wc_dist.jpeg")
boxplot(assist_key_pass_wc_top5$dist ~ assist_key_pass_wc_top5$Team.Name, main = "Assist or Key Pass Distance by Team", ylab = "Distance", xlab = "Team")
dev.off()

# Stack shot and goal dataset

shots_goals <-rbind(shots_clean, goals_clean)
shots_goals_wc <- subset(shots_goals, competition=="World Cup")

str(shots_goals_wc)
head(shots_goals_wc)

# Focus on top 5 teams with most goals + shots
freq2 <- sort(table(shots_goals_wc$Team.Name),decreasing=T)
print(freq2)

shots_goals_wc_top5 <- subset(shots_goals_wc, Team.Name == "Belgium" | Team.Name == "England" | Team.Name == "Croatia" | Team.Name == "Brazil" | Team.Name == "France")

jpeg(file="shots_goals_wc_dist.jpeg")
boxplot(shots_goals_wc_top5$dist ~ shots_goals_wc_top5$Team.Name, main = "Shot or Goal Distance by Team", ylab = "Distance", xlab = "Team")
dev.off()

jpeg(file="shots_goals_wc_x.jpeg")
boxplot(shots_goals_wc_top5$x.Start ~ shots_goals_wc_top5$Team.Name, main = "X.Start by Team", ylab = "X.Start", xlab = "Team")
dev.off()

jpeg(file="shots_goals_wc_y.jpeg")
boxplot(shots_goals_wc_top5$y.Start ~ shots_goals_wc_top5$Team.Name, main = "Y.Start by Team", ylab = "Y.Start", xlab = "Team")
dev.off()

```

The plots show some differences among teams. We continue by looking at these differences using an anova test.

```{r}
# install.packages("rstatix")
library(rstatix)

# Assist and Key Pass Distance
assist_key_pass_dist <- assist_key_pass_wc_top5 %>% anova_test(dist ~ Team.Name)

capture.output(assist_key_pass_dist, file = "anova.txt", append = T)

# Shots and Goals Distance
shots_goals_dist <- shots_goals_wc_top5 %>% anova_test(dist ~ Team.Name)

capture.output(shots_goals_dist, file = "anova.txt", append = T)

# Shots and Goals X.Start
shots_goals_x <- shots_goals_wc_top5 %>% anova_test(x.Start ~ Team.Name)

capture.output(shots_goals_x, file = "anova.txt", append = T)

# Shots and Goals Y.Start
shots_goals_y <- shots_goals_wc_top5 %>% anova_test(y.Start ~ Team.Name)

capture.output(shots_goals_y, file = "anova.txt", append = T)

```
Based on the anova tests, the top 5 teams (defined by event frequencies) have some significant differences in means of distances and start coordinates for the following variables:

1. Shots + Goals Distance
2. Shots + Goals Y.Start

Concluding Statement: Based on t-tests done between Shots vs Goals, and Assists vs Key Passes, there is evidence of distance and start coordinate differences between successful and unsuccessful plays. Applying this finding to the top 5 teams in the World Cup, we see further that there are teams that are significantly different in their tendencies for distance and Y.Start when it comes to attempting a goal.